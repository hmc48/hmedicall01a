<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>呼出システム</title>

<style>
body { font-family: system-ui; margin:0; background:#f2f2f7; }
header { background:#007bff; color:#fff; padding:10px; text-align:center; }
nav button { margin:4px; padding:6px 12px; }
.view { display:none; padding:10px; }
.view.active { display:block; }

.keypad {
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:8px;
  max-width:300px;
  margin:auto;
}
.keypad button {
  padding:18px;
  font-size:20px;
}

#display {
  text-align:center;
  font-size:28px;
  margin:10px;
}

#currentSettings {
  text-align:center;
  font-size:14px;
  color:#333;
  margin-bottom:10px;
}

.history {
  background:#fff;
  padding:8px;
  margin-top:10px;
  border-radius:6px;
}
</style>

<script>
const CONFIG = {"baseAudioUrl": "https://hmc48.github.io/hmedicall01a/audio", "characters": [{"id": "11_四国めたん", "name": "11_四国めたん", "image": "https://hmc48.github.io/hmedicall01a/images/11_四国めたん.webp", "voice": "001_四国めたん（ノーマル）"}, {"id": "12_ずんだもん", "name": "12_ずんだもん", "image": "https://hmc48.github.io/hmedicall01a/images/12_ずんだもん.webp", "voice": "001_ずんだもん（ノーマル）"}, {"id": "13_春日部つむぎ", "name": "13_春日部つむぎ", "image": "https://hmc48.github.io/hmedicall01a/images/13_春日部つむぎ.webp", "voice": "001_春日部つむぎ（ノーマル）"}], "chimes": ["＿", "チャイム1", "チャイム2", "チャイム3"], "prefixes": ["大変お待たせいたしました", "お待たせいたしました", "お呼び出しいたします", "＿"], "honorifics": ["でお待ちの方", "の方", "なし"], "blocks": ["＿", "Aブロック", "Bブロック", "Cブロック", "Dブロック"], "rooms_1000": ["0", "1", "2", "3", "4", "5", "6", "7", "8", "9"], "rooms_100": ["0", "1", "2", "3", "4", "5", "6", "7", "8", "9"], "rooms_10": ["0", "1", "2", "3", "4", "5", "6", "7", "8", "9"], "rooms_1": ["＿", "1番", "2番", "3番", "4番", "5番", "6番", "7番", "8番", "9番"], "places": ["窓口までお越しください", "受付までお越しください", "診察室までお越しください"]};
</script>
</head>

<body>

<header>
  <h2>呼出システム</h2>
  <nav>
    <button onclick="showView('home')">ホーム</button>
    <button onclick="showView('settings')">設定</button>
    <button onclick="showView('terms')">利用規約</button>
  </nav>
</header>

<div id="home" class="view active">
  <div id="display">----</div>

  <!-- ★ 設定内容表示 -->
  <div id="currentSettings">キャラクター：-</div>

  <div class="keypad">
    <button onclick="addNum(1)">1</button>
    <button onclick="addNum(2)">2</button>
    <button onclick="addNum(3)">3</button>
    <button onclick="addNum(4)">4</button>
    <button onclick="addNum(5)">5</button>
    <button onclick="addNum(6)">6</button>
    <button onclick="addNum(7)">7</button>
    <button onclick="addNum(8)">8</button>
    <button onclick="addNum(9)">9</button>
    <button onclick="clearNum()">C</button>
    <button onclick="addNum(0)">0</button>
    <button onclick="backspace()">←</button>
  </div>

  <p style="text-align:center">
    <button onclick="callNumber()">▶ 呼出</button>
  </p>

  <div class="history">
    <b>呼出履歴（最新10件）</b>
    <ul id="history"></ul>
  </div>
</div>

<div id="settings" class="view">
  <h3>設定</h3>

  <a href="https://voicevox.hiroshiba.jp/" target="_blank" rel="noopener">
    <button type="button">キャラクター詳細</button>

  </a>
  <br><br>

  <label>キャラクター</label><br>
  <select id="character"><option value="11_四国めたん">11_四国めたん</option><option value="12_ずんだもん">12_ずんだもん</option><option value="13_春日部つむぎ">13_春日部つむぎ</option></select>
  <img id="characterImage" src="" alt="キャラクター画像" style="height:100px; vertical-align:middle; margin-left:10px;"><br><br>

  
  <label>チャイム</label><br>
  <select id="chime"><option>＿</option><option>チャイム1</option><option>チャイム2</option><option>チャイム3</option></select><br><br>

  <label>前文</label><br>
  <select id="prefix"><option>大変お待たせいたしました</option><option>お待たせいたしました</option><option>お呼び出しいたします</option><option>＿</option></select><br><br>

  <label>ブロック</label><br>
  <select id="block"><option>＿</option><option>Aブロック</option><option>Bブロック</option><option>Cブロック</option><option>Dブロック</option></select><br><br>

  <label>部屋番号千の位</label><br>
  <select id="rooms_1000"><option>0</option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option><option>7</option><option>8</option><option>9</option></select><br><br>

  <label>部屋番号百の位</label><br>
  <select id="rooms_100"><option>0</option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option><option>7</option><option>8</option><option>9</option></select><br><br>

  <label>部屋番号十の位</label><br>
  <select id="rooms_10"><option>0</option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option><option>7</option><option>8</option><option>9</option></select><br><br>

  <label>部屋番号一の位</label><br>
  <select id="rooms_1"><option>＿</option><option>1番</option><option>2番</option><option>3番</option><option>4番</option><option>5番</option><option>6番</option><option>7番</option><option>8番</option><option>9番</option></select><br><br>

  <label>場所</label><br>
  <select id="place"><option>窓口までお越しください</option><option>受付までお越しください</option><option>診察室までお越しください</option></select><br><br>

  <button onclick="saveSettings()">決定</button>
</div>

<div id="terms" class="view">
  <h3>利用規約</h3>
  <p>本システムは音声案内目的で使用してください。</p>
</div>

<script>
let currentNum = "";

let settings = JSON.parse(localStorage.getItem("settings")) || {
  character: CONFIG.characters[0].id,
  chime: CONFIG.chimes[0],
  prefix: CONFIG.prefixes[0],
  block: CONFIG.blocks[0],
  room_1000: CONFIG.rooms_1000[0],
  room_100: CONFIG.rooms_100[0],
  room_10: CONFIG.rooms_10[0],
  room_1: CONFIG.rooms_1[0],
  place: CONFIG.places[0]
};

function showView(id) {
  document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

function addNum(n) {
  if (currentNum.length >= 4) return;
  currentNum += n;
  updateDisplay();
}

function clearNum() {
  currentNum = "";
  updateDisplay();
}

function backspace() {
  currentNum = currentNum.slice(0,-1);
  updateDisplay();
}

function updateDisplay() {
  document.getElementById("display").innerText =
    currentNum.padStart(4,"-");
}

function renderCurrentSettings() {
  const char = CONFIG.characters.find(c => c.id === settings.character);
  document.getElementById("currentSettings").innerHTML = `
    <div>${char ? char.name : "-"} ${settings.chime} ${settings.block}</div>
    <div>${settings.room_1000}${settings.room_100}${settings.room_10}${settings.room_1} ${settings.place}</div>
` ;
}



async function playSequence(list) {
  for (const src of list) {
    await new Promise(r => {
      const a = new Audio(src);
      a.onended = r;
      a.play();
    });
  }
}

function numberFiles(num, base) {
  const s = num.padStart(4,"0");
  const f = [];
  if (s[0]!="0") f.push(`${base}/number/${s[0]}000.mp3`);
  if (s[1]!="0") f.push(`${base}/number/${s[1]}00.mp3`);
  if (s[2]!="0") f.push(`${base}/number/${s[2]}0.mp3`);
  if (s[3]!="0") f.push(`${base}/number/${s[3]}.mp3`);
  return f;
}

async function callNumber() {
  if (!currentNum) return alert("番号未入力");

  const base = `${CONFIG.baseAudioUrl}/${settings.character}`;
  const files = [];

  files.push(`${CONFIG.baseAudioUrl}/chime/${settings.chime}`);
  files.push(`${base}/prefix/${settings.prefix}.mp3`);
  files.push(...numberFiles(currentNum, base));
  files.push(`${base}/honorific/でお待ちの方.mp3`);
  files.push(`${base}/block/${settings.block}.mp3`);
  files.push(...numberFiles(currentNum, base));
  files.push(`${base}/place/${settings.place}.mp3`);

  await playSequence(files);
  addHistory(currentNum);
  clearNum();
}

function addHistory(num) {
  const h = JSON.parse(localStorage.getItem("history")||"[]");
  h.unshift({num:num, time:new Date().toLocaleTimeString()});
  localStorage.setItem("history", JSON.stringify(h.slice(0,10)));
  renderHistory();
}

function renderHistory() {
  const ul = document.getElementById("history");
  ul.innerHTML="";
  const h = JSON.parse(localStorage.getItem("history")||"[]");
  h.forEach(i=>{
    const li=document.createElement("li");
    li.textContent = `${i.time} 呼出 ${i.num}`;
    ul.appendChild(li);
  });
}

const characterSelect = document.getElementById("character");
const characterImage  = document.getElementById("characterImage");

// 初期表示
function updateCharacterImage() {
  const char = CONFIG.characters.find(c => c.id === characterSelect.value);
  if(char){
    characterImage.src = char.image;
  } else {
    characterImage.src = "";
  }
}
updateCharacterImage();

// 選択変更時に更新
characterSelect.addEventListener("change", updateCharacterImage);

function saveSettings() {
  settings = {
    character: character.value,
    chime: chime.value,
    prefix: prefix.value,
    block: block.value,
    room_1000: rooms_1000.value,
    room_100: rooms_100.value,
    room_10: rooms_10.value,
    room_1: rooms_1.value,
    place: place.value
  };
  localStorage.setItem("settings", JSON.stringify(settings));
  renderCurrentSettings();
  alert("保存しました");
}

renderHistory();
updateDisplay();
renderCurrentSettings();
</script>

</body>
</html>
