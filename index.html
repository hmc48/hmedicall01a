<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>呼出システム</title>
<style>
/* ===== 設定タイトル横ボタン ===== */
.settings-header {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 12px;
  margin-bottom: 10px;
}

.character-detail-button {
  padding: 6px 12px;
  font-size: 14px;
  background-color: #17a2b8;
  color: white;
  border-radius: 6px;
  text-decoration: none;
  font-weight: bold;
}

.character-detail-button:hover {
  background-color: #117a8b;
}
 </style>
<style>
body { font-family: system-ui; margin:0; background:#f2f2f7; }
header { background:#007bff; color:#fff; padding:10px; text-align:center; position:relative; min-height:80px; }
header h2 { margin:0; }
nav button { margin:4px; padding:6px 12px; }
.view { display:none; padding:10px; }
.view.active { display:block; }
.keypad { display:grid; grid-template-columns:repeat(3,1fr); gap:8px; max-width:300px; margin:auto; }
.keypad button { padding:18px; font-size:20px; }
#display { text-align:center; font-size:28px; margin:10px; }
#currentSettings { text-align:center; font-size:14px; color:#333; margin-bottom:10px; }
.history { background:#fff; padding:8px; margin-top:10px; border-radius:6px; border:1px solid #ddd; }
#headerCharacterImage { position:absolute; top:5px; left:10px; height:80px; }
#headerImageCredit { position:absolute; top:5px; right:10px; height:30px; }
#callButton { padding: 20px 50px; font-size: 24px; font-weight: bold; border-radius: 12px; background-color: #28a745; color: white; border: none; cursor: pointer; display: block; margin: 20px auto; }
#callButton:active { background-color: #1e7e34; }
#saveSettingsButton {
  padding: 20px 50px;
  font-size: 24px;
  font-weight: bold;
  border-radius: 12px;
  background-color: #007bff;
  color: white;
  border: none;
  cursor: pointer;
  display: block;
  margin: 20px auto;
}
#saveSettingsButton:active {
  background-color: #0056b3;
}

/* ===== ご案内画面ではナビを簡素化 ===== */
.info-mode header nav button {
  display: none;
}

/* ホームボタンだけ表示 */
.info-mode header nav button:first-child {
  display: inline-block;
}

/* ===== ご案内画面 ===64P→100P== */
.info-title {
  text-align: center;
  margin: 10px 0;
}

.info-current {
  background: #007bff;
  color: #fff;
  font-size: 100px;
  font-weight: bold;
  text-align: center;
  padding: 30px 0;
  border-radius: 12px;
  margin-bottom: 20px;
}

/* 履歴グリッド */
.info-history {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 12px;
}

/* 履歴ボックス */
.info-box {
  background: #007bff;
  color: #fff;
  font-size: 32px;
  font-weight: bold;
  text-align: center;
  padding: 20px 0;
  border-radius: 10px;
}

/* ===== ご案内画面ではナビを右寄せ ===== */
.info-mode header nav {
  display: flex;
  justify-content: flex-end;   /* ★ 右寄せ */
}

/* 余白調整（右端にくっつきすぎないように） */
.info-mode header nav button {
  margin-right: 10px;
}

/* ===== ご案内画面ではタイトルを大きく ===== */
.info-mode header h2 {
  font-size: clamp(28px, 4vw, 42px);
  font-weight: bold;
  letter-spacing: 0.1em;
  margin-top: 10px;
}

/* ===== 表示盤風：タイトルをさらに強調 ===== */
.info-mode header h2 {
  text-shadow: 0 2px 4px rgba(0,0,0,0.3);
}

/* ===== iPad横向き・大画面向け（自動調整） ===== */
@media (min-width: 768px) {
  .info-mode header h2 {
    font-size: clamp(36px, 3vw, 56px);
  }

  .info-current {
    font-size: clamp(64px, 8vw, 96px);
  }

  .info-box {
    font-size: clamp(28px, 4vw, 40px);
  }
}

/* ===== 設定保存ボタン（キャラクター詳細と同サイズ・同系色） ===== */
.save-settings-button {
  padding: 9px 10px;        /* サイズ統一 */
  font-size: 12px;           /* 文字サイズ統一 */
  font-weight: bold;

  background-color: #007bff; /* 青 */
  color: #ffffff;            /* 白 */

  border: none;
  border-radius: 6px;
  cursor: pointer;
}

</style>
</head>
<body>

<header>
  <img id="headerCharacterImage" src="" alt="">
  <img id="headerImageCredit" src="" alt="">
  <h2>ご案内</h2>
  <nav>
    <button onclick="showView('home')">ホーム</button>
    <button onclick="showView('Information')">ご案内</button>
    <button onclick="showView('settings')">設定</button>
    <button onclick="showView('terms')">説明.規約</button>
  </nav>
</header>

<div id="home" class="view active">
  <div id="display">----</div>
  <div id="currentSettings">読み込み中...</div>
  <div class="keypad">
    <button onclick="addNum(1)">1</button><button onclick="addNum(2)">2</button><button onclick="addNum(3)">3</button>
    <button onclick="addNum(4)">4</button><button onclick="addNum(5)">5</button><button onclick="addNum(6)">6</button>
    <button onclick="addNum(7)">7</button><button onclick="addNum(8)">8</button><button onclick="addNum(9)">9</button>
    <button onclick="clearDisplay()">クリア</button><button onclick="addNum(0)">0</button><button onclick="backspace()">BS</button>
  </div>
  <button id="callButton" onclick="call()">呼出</button>
  <div id="historyList"></div>
</div>

<div id="settings" class="view">

<div class="settings-header">

<button class="save-settings-button" onclick="saveSettings()">
  設定を保存
</button>


  <a
    class="character-detail-button"
    href="https://voicevox.hiroshiba.jp/product/shikoku_metan/"
    target="_blank"
    rel="noopener noreferrer"
  >
    キャラ詳細
  </a>

    <a
    class="character-detail-button"
    href="https://voicevox.su-shiki.com/vertical/"
    target="_blank"
    rel="noopener noreferrer"
  >
    フリー入力
  </a>

</div>

  <p>キャラクター: <select id="characterSelect"><option value="11_shikoku">11_四国めたん</option><option value="12_zundamon">12_ずんだもん</option><option value="13_kasukabe">13_春日部つむぎ</option><option value="14_amehare">14_雨晴はう</option><option value="15_namine">15_波音リツ</option><option value="16_kurono">16_玄野武宏</option><option value="17_shirakami">17_白上虎太郎</option><option value="18_aoyama">18_青山龍星</option><option value="19_meimei">19_冥鳴ひまり</option><option value="20_kyushu">20_九州そら</option><option value="21_mochiko">21_もち子さん</option><option value="22_kenzaki">22_剣崎雌雄</option><option value="23_whitecul">23_WhiteCUL</option><option value="24_goki">24_後鬼</option></select></p>
  <p>チャイム音: <select id="chime"><option value="">なし</option><option value="m_chime01">チャイム1</option><option value="m_chime02">チャイム2</option><option value="m_chime03">チャイム3</option><option value="m_chime04">チャイム4</option><option value="m_chime05">チャイム5</option><option value="m_chime06">チャイム6</option><option value="m_chime07">チャイム7</option><option value="m_chime08">チャイム8</option><option value="m_chime09">チャイム9</option><option value="m_chime10">チャイム10</option></select></p>
  <p>接頭語: <select id="prefix"><option value="">なし</option><option value="01_01">お呼び出しいたします</option><option value="01_02">お待たせいたしました</option><option value="01_03">大変お待たせいたしました</option></select></p>
  <p>敬称: <select id="honorific"><option value="">なし</option><option value="06_01">でお待ちの方</option><option value="06_02">の方</option></select></p>
  <p>再生速度: <select id="playbackRate"><option value="0.8">0.8倍</option><option value="0.9">0.9倍</option><option value="1.0">1.0倍</option><option value="1.1">1.1倍</option><option value="1.2">1.2倍</option><option value="1.3">1.3倍</option><option value="1.4">1.4倍</option><option value="1.5">1.5倍</option></select></p>
  <p>ブロック: <select id="block"><option value="">なし</option><option value="07_a">Aブロック</option><option value="07_b">Bブロック</option><option value="07_c">Cブロック</option><option value="07_d">Dブロック</option><option value="07_e">Eブロック</option><option value="07_f">Fブロック</option><option value="07_g">Gブロック</option><option value="07_h">Hブロック</option><option value="07_i">Iブロック</option><option value="07_j">Jブロック</option><option value="07_k">Kブロック</option><option value="07_l">Lブロック</option><option value="07_m">Mブロック</option><option value="07_n">Nブロック</option><option value="07_o">Oブロック</option><option value="07_p">Pブロック</option><option value="07_q">Qブロック</option><option value="07_r">Rブロック</option><option value="07_s">Sブロック</option><option value="07_t">Tブロック</option><option value="07_u">Uブロック</option><option value="07_v">Vブロック</option><option value="07_w">Wブロック</option><option value="07_x">Xブロック</option><option value="07_y">Yブロック</option><option value="07_z">Zブロック</option></select></p>
  <p>【室番号】</p>
  <p>1000の位: <select id="rooms_1000"><option value="">なし</option><option value="02_1000">1</option><option value="02_2000">2</option><option value="02_3000">3</option><option value="02_4000">4</option><option value="02_5000">5</option><option value="02_6000">6</option><option value="02_7000">7</option><option value="02_8000">8</option><option value="02_9000">9</option></select></p>
  <p>100の位: <select id="rooms_100"><option value="">なし</option><option value="0">0</option><option value="03_100">1</option><option value="03_200">2</option><option value="03_300">3</option><option value="03_400">4</option><option value="03_500">5</option><option value="03_600">6</option><option value="03_700">7</option><option value="03_800">8</option><option value="03_900">9</option></select></p>
  <p>10の位: <select id="rooms_10"><option value="">なし</option><option value="0">0</option><option value="04_10">1</option><option value="04_20">2</option><option value="04_30">3</option><option value="04_40">4</option><option value="04_50">5</option><option value="04_60">6</option><option value="04_70">7</option><option value="04_80">8</option><option value="04_90">9</option></select></p>
  <p>1の位: <select id="rooms_1"><option value="">なし</option><option value="0">0</option><option value="05_1">1</option><option value="05_2">2</option><option value="05_3">3</option><option value="05_4">4</option><option value="05_5">5</option><option value="05_6">6</option><option value="05_7">7</option><option value="05_8">8</option><option value="05_9">9</option></select></p>
  <p>呼出場所: <select id="place"><option value="">なし</option><option value="08_01">お入りください</option><option value="08_02">受付までお越しください</option><option value="08_03">処置室までお越しください</option><option value="08_04">診察室までお越しください</option><option value="08_05">窓口までお越しください</option><option value="08_06">カウンターまでお越しください</option></select></p>

</div>

<div id="Information" class="view">
  <h2 class="info-title">次の番号の方はお呼びしています</h2>

  <!-- 現在呼出番号 -->
  <div id="infoCurrent" class="info-current">----</div>

  <!-- 履歴 -->
  <div id="infoHistory" class="info-history"></div>
</div>

<div id="terms" class="view">
  <h3>説明、利用規約</h3>
  <p>本システムは、以下を利用したシンプルな仕組みの呼出システムです。</p><br>
【出典】<br>
VOICEVOX 無料で使える中品質なテキスト読み上げ・歌声合成ソフトウェア<br>
<a href="https://voicevox.hiroshiba.jp/" target="_blank" rel="noopener noreferrer" onclick="event.stopPropagation();">https://voicevox.hiroshiba.jp/</a><br>
【初めに】<br>
本システムは、主にスマートフォンから簡単に呼出操作を行い、<br>
サブモニターやBluetoothスピーカーを接続することで、手軽にご利用環境を構築できます。<br>
【操作方法】<br>
初めに、以下の内容を設定して保存します。<br>
・キャラクター<br>
・チャイム音<br>
・接頭語、敬称<br>
・呼出場所<br>
・再生スピード<br>
設定後、ホーム画面で呼出番号をクリック（タップ）し、呼出ボタンを選択すると音声が再生されます。<br>
呼出中は、ご案内画面に呼出番号が表示されます（最大10件まで表示可能です）。<br>
〇音声案内例〇<br>
「お待たせいたしました。〇〇番でお待ちの方、3番受付までお越しください。」<br>
★キャラクター詳細★<br>
キャラクターの情報が掲載された外部サイトが表示されます。<br>
★フリー入力★<br>
「フリー入力」が可能な外部サイトが表示されます。<br>
キャラクター選択、テキスト入力で、自由な内容の音声を作成できます。<br>
〇入力例〇<br>
「お車の移動をお願いします。アルファード品川……」<br>
<br>
【利用規約・ご意見・ご感想・お問い合わせ】<br>
本システムをご利用の際は、利用規約をご確認のうえ、内容に同意いただいた上でご利用ください。
本ツールは以下のサイトで作成しています。
<a href="https://sites.google.com/view/indexm" target="_blank" rel="noopener noreferrer" onclick="event.stopPropagation();">https://sites.google.com/view/indexm</a><br>
作成者:Mana48FanClub<br>
<p>
</div>


<script>
const CONFIG = {"baseAudioUrl": "https://hmc48.github.io/hmedicall01a/setting", "characters": [{"id": "11_shikoku", "name": "11_四国めたん", "voice": "11_shikoku", "image": "https://hmc48.github.io/hmedicall01a/images/11_四国めたん.webp", "image_credit": "https://hmc48.github.io/hmedicall01a/images_credit/11_四国めたん.png"}, {"id": "12_zundamon", "name": "12_ずんだもん", "voice": "12_zundamon", "image": "https://hmc48.github.io/hmedicall01a/images/12_ずんだもん.webp", "image_credit": "https://hmc48.github.io/hmedicall01a/images_credit/12_ずんだもん.png"}, {"id": "13_kasukabe", "name": "13_春日部つむぎ", "voice": "13_kasukabe", "image": "https://hmc48.github.io/hmedicall01a/images/13_春日部つむぎ.webp", "image_credit": "https://hmc48.github.io/hmedicall01a/images_credit/13_春日部つむぎ.png"}, {"id": "14_amehare", "name": "14_雨晴はう", "voice": "14_amehare", "image": "https://hmc48.github.io/hmedicall01a/images/14_雨晴はう.webp", "image_credit": "https://hmc48.github.io/hmedicall01a/images_credit/14_雨晴はう.png"}, {"id": "15_namine", "name": "15_波音リツ", "voice": "15_namine", "image": "https://hmc48.github.io/hmedicall01a/images/15_波音リツ.webp", "image_credit": "https://hmc48.github.io/hmedicall01a/images_credit/15_波音リツ.png"}, {"id": "16_kurono", "name": "16_玄野武宏", "voice": "16_kurono", "image": "https://hmc48.github.io/hmedicall01a/images/16_玄野武宏.webp", "image_credit": "https://hmc48.github.io/hmedicall01a/images_credit/16_玄野武宏.png"}, {"id": "17_shirakami", "name": "17_白上虎太郎", "voice": "17_shirakami", "image": "https://hmc48.github.io/hmedicall01a/images/17_白上虎太郎.webp", "image_credit": "https://hmc48.github.io/hmedicall01a/images_credit/17_白上虎太郎.png"}, {"id": "18_aoyama", "name": "18_青山龍星", "voice": "18_aoyama", "image": "https://hmc48.github.io/hmedicall01a/images/18_青山龍星.webp", "image_credit": "https://hmc48.github.io/hmedicall01a/images_credit/18_青山龍星.png"}, {"id": "19_meimei", "name": "19_冥鳴ひまり", "voice": "19_meimei", "image": "https://hmc48.github.io/hmedicall01a/images/19_冥鳴ひまり.webp", "image_credit": "https://hmc48.github.io/hmedicall01a/images_credit/19_冥鳴ひまり.png"}, {"id": "20_kyushu", "name": "20_九州そら", "voice": "20_kyushu", "image": "https://hmc48.github.io/hmedicall01a/images/20_九州そら.webp", "image_credit": "https://hmc48.github.io/hmedicall01a/images_credit/20_九州そら.png"}, {"id": "21_mochiko", "name": "21_もち子さん", "voice": "21_mochiko", "image": "https://hmc48.github.io/hmedicall01a/images/21_もち子さん.webp", "image_credit": "https://hmc48.github.io/hmedicall01a/images_credit/21_もち子さん.png"}, {"id": "22_kenzaki", "name": "22_剣崎雌雄", "voice": "22_kenzaki", "image": "https://hmc48.github.io/hmedicall01a/images/22_剣崎雌雄.webp", "image_credit": "https://hmc48.github.io/hmedicall01a/images_credit/22_剣崎雌雄.png"}, {"id": "23_whitecul", "name": "23_WhiteCUL", "voice": "23_whitecul", "image": "https://hmc48.github.io/hmedicall01a/images/23_WhiteCUL.webp", "image_credit": "https://hmc48.github.io/hmedicall01a/images_credit/23_WhiteCUL.png"}, {"id": "24_goki", "name": "24_後鬼", "voice": "24_goki", "image": "https://hmc48.github.io/hmedicall01a/images/24_後鬼.webp", "image_credit": "https://hmc48.github.io/hmedicall01a/images_credit/24_後鬼.png"}], "chimes": [{"label": "なし", "value": ""}, {"label": "チャイム1", "value": "m_chime01"}, {"label": "チャイム2", "value": "m_chime02"}, {"label": "チャイム3", "value": "m_chime03"}, {"label": "チャイム4", "value": "m_chime04"}, {"label": "チャイム5", "value": "m_chime05"}, {"label": "チャイム6", "value": "m_chime06"}, {"label": "チャイム7", "value": "m_chime07"}, {"label": "チャイム8", "value": "m_chime08"}, {"label": "チャイム9", "value": "m_chime09"}, {"label": "チャイム10", "value": "m_chime10"}], "prefixes": [{"label": "なし", "value": ""}, {"label": "お呼び出しいたします", "value": "01_01"}, {"label": "お待たせいたしました", "value": "01_02"}, {"label": "大変お待たせいたしました", "value": "01_03"}], "honorifics": [{"label": "なし", "value": ""}, {"label": "でお待ちの方", "value": "06_01"}, {"label": "の方", "value": "06_02"}], "blocks": [{"label": "なし", "value": ""}, {"label": "Aブロック", "value": "07_a"}, {"label": "Bブロック", "value": "07_b"}, {"label": "Cブロック", "value": "07_c"}, {"label": "Dブロック", "value": "07_d"}, {"label": "Eブロック", "value": "07_e"}, {"label": "Fブロック", "value": "07_f"}, {"label": "Gブロック", "value": "07_g"}, {"label": "Hブロック", "value": "07_h"}, {"label": "Iブロック", "value": "07_i"}, {"label": "Jブロック", "value": "07_j"}, {"label": "Kブロック", "value": "07_k"}, {"label": "Lブロック", "value": "07_l"}, {"label": "Mブロック", "value": "07_m"}, {"label": "Nブロック", "value": "07_n"}, {"label": "Oブロック", "value": "07_o"}, {"label": "Pブロック", "value": "07_p"}, {"label": "Qブロック", "value": "07_q"}, {"label": "Rブロック", "value": "07_r"}, {"label": "Sブロック", "value": "07_s"}, {"label": "Tブロック", "value": "07_t"}, {"label": "Uブロック", "value": "07_u"}, {"label": "Vブロック", "value": "07_v"}, {"label": "Wブロック", "value": "07_w"}, {"label": "Xブロック", "value": "07_x"}, {"label": "Yブロック", "value": "07_y"}, {"label": "Zブロック", "value": "07_z"}], "rooms_1000": [{"label": "なし", "value": ""}, {"label": "1", "value": "02_1000"}, {"label": "2", "value": "02_2000"}, {"label": "3", "value": "02_3000"}, {"label": "4", "value": "02_4000"}, {"label": "5", "value": "02_5000"}, {"label": "6", "value": "02_6000"}, {"label": "7", "value": "02_7000"}, {"label": "8", "value": "02_8000"}, {"label": "9", "value": "02_9000"}], "rooms_100": [{"label": "なし", "value": ""}, {"label": "0", "value": "0"}, {"label": "1", "value": "03_100"}, {"label": "2", "value": "03_200"}, {"label": "3", "value": "03_300"}, {"label": "4", "value": "03_400"}, {"label": "5", "value": "03_500"}, {"label": "6", "value": "03_600"}, {"label": "7", "value": "03_700"}, {"label": "8", "value": "03_800"}, {"label": "9", "value": "03_900"}], "rooms_10": [{"label": "なし", "value": ""}, {"label": "0", "value": "0"}, {"label": "1", "value": "04_10"}, {"label": "2", "value": "04_20"}, {"label": "3", "value": "04_30"}, {"label": "4", "value": "04_40"}, {"label": "5", "value": "04_50"}, {"label": "6", "value": "04_60"}, {"label": "7", "value": "04_70"}, {"label": "8", "value": "04_80"}, {"label": "9", "value": "04_90"}], "rooms_1": [{"label": "なし", "value": ""}, {"label": "0", "value": "0"}, {"label": "1", "value": "05_1"}, {"label": "2", "value": "05_2"}, {"label": "3", "value": "05_3"}, {"label": "4", "value": "05_4"}, {"label": "5", "value": "05_5"}, {"label": "6", "value": "05_6"}, {"label": "7", "value": "05_7"}, {"label": "8", "value": "05_8"}, {"label": "9", "value": "05_9"}], "places": [{"label": "なし", "value": ""}, {"label": "お入りください", "value": "08_01"}, {"label": "受付までお越しください", "value": "08_02"}, {"label": "処置室までお越しください", "value": "08_03"}, {"label": "診察室までお越しください", "value": "08_04"}, {"label": "窓口までお越しください", "value": "08_05"}, {"label": "カウンターまでお越しください", "value": "08_06"}], "playbackRates": [0.8, 0.9, 1.0, 1.1, 1.2, 1.3, 1.4, 1.5]};
let currentNum = "";
let history = JSON.parse(localStorage.getItem("history") || "[]");
let settings = JSON.parse(localStorage.getItem("settings") || '{}');
let isPlaying = false;

// ===== シームレス再生用 AudioContext =====
let audioCtx = null;

// ★ ③ 画面OFF → ON 復帰時の完全リセット（iOS Safari 対策）
document.addEventListener("visibilitychange", () => {
  if (document.visibilityState === "visible") {
    if (audioCtx) {
      try {
        audioCtx.close();
      } catch (e) {}
      audioCtx = null;
    }
  }
});

// 要素の取得
const display = document.getElementById("display");
const historyList = document.getElementById("historyList");
const characterSelect = document.getElementById("characterSelect");

// 初期表示
window.onload = () => {
  loadFormValues();
  updateUI();
  renderHistory();
};

function showView(id) {
  document.querySelectorAll(".view").forEach(v => v.classList.remove("active"));
  document.getElementById(id).classList.add("active");

  // ★ 画面切替時の初期化（ご案内画面）  
  if (id === "Information") {
    document.body.classList.add("info-mode");   // ★ 追加
    renderInformationHistory();
  } else {
    document.body.classList.remove("info-mode"); // ★ 追加
  }
}

function addNum(n) { currentNum += n; updateDisplay(); }
function clearDisplay() { currentNum = ""; updateDisplay(); }
function backspace() { currentNum = currentNum.slice(0,-1); updateDisplay(); }
function updateDisplay() { display.innerText = currentNum || "----"; }

function updateUI() {
  const char = CONFIG.characters.find(c => c.id === (settings.character || CONFIG.characters[0].id));
  if(char) {
    document.getElementById("headerCharacterImage").src = char.image;
    document.getElementById("headerImageCredit").src = char.image_credit;

    // 表示したい項目を配列にまとめる
    const displayParts = [` ${char.name}`];

    if (settings.chime) {
      // ファイル名から表示用ラベルを取得
      const chimeObj = CONFIG.chimes.find(c => c.value === settings.chime);
      if (chimeObj) {
        displayParts.push(` ${chimeObj.label}`);
      }
    }

    if (settings.prefix) {
      const p = CONFIG.prefixes.find(
        x => x.value === settings.prefix
      );
      if (p) {
        displayParts.push(` ${p.label}`);
      }
    }
    displayParts.push("〇〇番");

    if (settings.honorific) {
      const p = CONFIG.honorifics.find(
        x => x.value === settings.honorific
      );
      if (p) {
        displayParts.push(` ${p.label}`);
      }
    }

    if (settings.block) {
      const p = CONFIG.blocks.find(
        x => x.value === settings.block
      );
      if (p) {
        displayParts.push(` ${p.label}`);
      }
    }

    if (settings.room_1000) {
      const p = CONFIG.rooms_1000.find(
        x => x.value === settings.room_1000
      );
      if (p) {
        displayParts.push(` ${p.label}`);
      }
    }

    if (settings.room_100) {
      const p = CONFIG.rooms_100.find(
        x => x.value === settings.room_100
      );
      if (p) {
        displayParts.push(` ${p.label}`);
      }
    }

    if (settings.room_10) {
      const p = CONFIG.rooms_10.find(
        x => x.value === settings.room_10
      );
      if (p) {
        displayParts.push(` ${p.label}`);
      }
    }

    if (settings.room_1) {
      const p = CONFIG.rooms_1.find(
        x => x.value === settings.room_1
      );
      if (p) {
        displayParts.push(` ${p.label}番`);
      }
    }

    if (settings.place) {
      const p = CONFIG.places.find(
        x => x.value === settings.place
      );
      if (p) {
        displayParts.push(` ${p.label}`);
      }
    }
    
    if (settings.playbackRate) {
      displayParts.push(` (${settings.playbackRate}倍)`);
    }

    // 配列の中身を「」でつなげて画面表示
    document.getElementById("currentSettings").innerText = displayParts.join("");
  }
}

function saveSettings() {
  settings = {
    character: characterSelect.value,
    chime: document.getElementById("chime").value,
    prefix: document.getElementById("prefix").value,
    honorific: document.getElementById("honorific").value,
    block: document.getElementById("block").value,
    room_1000: document.getElementById("rooms_1000").value,
    room_100: document.getElementById("rooms_100").value,
    room_10: document.getElementById("rooms_10").value,
    room_1: document.getElementById("rooms_1").value,
    place: document.getElementById("place").value,
    playbackRate: parseFloat(document.getElementById("playbackRate").value)
  };
  localStorage.setItem("settings", JSON.stringify(settings));
  updateUI();
  alert("設定を保存しました");
}

function loadFormValues() {
  characterSelect.value = settings.character;
  document.getElementById("chime").value = settings.chime;
  document.getElementById("prefix").value = settings.prefix;
  document.getElementById("honorific").value = settings.honorific;
  document.getElementById("block").value = settings.block;
  document.getElementById("rooms_1000").value = settings.room_1000;
  document.getElementById("rooms_100").value = settings.room_100;
  document.getElementById("rooms_10").value = settings.room_10;
  document.getElementById("rooms_1").value = settings.room_1;
  document.getElementById("place").value = settings.place;
  document.getElementById("playbackRate").value = settings.playbackRate || 1.0;
}

/* ===== シームレス再生関数（★ここ）===== */
async function playPlaylistGapless(playlist) {
  // ★ 修正②：AudioContext 生存チェック（iOS省電力復帰対策）
  if (!audioCtx || audioCtx.state === "closed") {
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  }

  if (audioCtx.state === "suspended") {
    await audioCtx.resume();
  }

  // すべてのMP3を並列で読み込み＆デコード
  const buffers = await Promise.all(
    playlist.map(async (url) => {
      const res = await fetch(url);
      if (!res.ok) {
        console.warn("skip missing audio:", url);
        return null;
      }
      const arrayBuffer = await res.arrayBuffer();
      return await audioCtx.decodeAudioData(arrayBuffer);
    })
  );

  const rate = settings.playbackRate || 1.0;

  // スケジュール再生（ギャップレス）
  let startTime = audioCtx.currentTime;

  buffers.filter(Boolean).forEach(buffer => {
    const source = audioCtx.createBufferSource();
    source.buffer = buffer;
    source.playbackRate.value = rate;
    source.connect(audioCtx.destination);
    source.start(startTime);

    startTime += buffer.duration / rate;
  });

  // 再生完了待ち
  const totalMs = (startTime - audioCtx.currentTime) * 1000;
  return new Promise(resolve => setTimeout(resolve, totalMs));
}

// ===== UIロック／解除 =====
function lockUI(lock) {
  document.querySelectorAll("button, select").forEach(el => {
    el.disabled = lock;
  });

  const callBtn = document.getElementById("callButton");
  if (callBtn) {
    callBtn.innerText = lock ? "再生中…" : "呼出";
  }
}

async function call() {
  // 二重再生防止
  if (isPlaying) return;

  // ★追加：未入力チェック（ここを修正）
    if (currentNum === "") {
      alert("番号を入力してください。");
      return; // ここで処理を中断
    }

  // ★ iOS対策：毎回 AudioContext を作り直す
  if (audioCtx) {
    try {
      audioCtx.close();
    } catch(e) {}
  }
  audioCtx = new (window.AudioContext || window.webkitAudioContext)();
 
  // ★ Safari / iOS / Chrome 対策（await を使わない）
  if (audioCtx.state === "suspended") {
    audioCtx.resume();
  }

  showView("Information");   // 画面切替

  const callNum = currentNum || "0";

  // ===== 番号チェック =====
  if (!callNum || parseInt(callNum, 10) > 9999) {
    alert("番号は0〜9999の範囲で入力してください。");
    return; // 処理中断（UIロックされない）
  }

  // UIロック & 再生フラグ
  isPlaying = true;
  lockUI(true);

  try {
    // 履歴登録
    const now = new Date().toLocaleTimeString();
    history.unshift({ num: callNum, time: now });
    if (history.length > 10) history.pop();
    localStorage.setItem("history", JSON.stringify(history));
    renderHistory();
    updateInformationCurrent(callNum);
    renderInformationHistory();   // ★ 追加

    const char = CONFIG.characters.find(
      c => c.id === (settings.character || CONFIG.characters[0].id)
    );
    const baseUrl = CONFIG.baseAudioUrl;
    const v = char.voice;
    const cid = char.id;
    const playlist = [];

    // ===== チャイム =====
    if (settings.chime) {
      playlist.push(`${baseUrl}/m_chime/${settings.chime}.mp3`);
    }

    // ===== 接頭語 =====
    if (settings.prefix) {
      playlist.push(`${baseUrl}/${cid}/01_prefixes/${v}_${settings.prefix}.mp3`);
    }

    // ===== 電卓入力の数字（修正後）=====
    const num = callNum.padStart(4, "0");
    const n1000 = num[0], n100 = num[1], n10 = num[2], n1 = num[3];

    if (n1000 !== "0") {
      playlist.push(`${baseUrl}/${cid}/02_call_1000/${v}_02_${n1000}000.mp3`);
    }
    if (n100 !== "0") {
      playlist.push(`${baseUrl}/${cid}/03_call_100/${v}_03_${n100}00.mp3`);
    }
    if (n10 !== "0") {
      playlist.push(`${baseUrl}/${cid}/04_call_10/${v}_04_${n10}0.mp3`);
    }
    if (n1 !== "0") {
      playlist.push(`${baseUrl}/${cid}/05_call_1/${v}_05_${n1}.mp3`);
    } else {
        // 0の場合は「番.mp3」を再生
        playlist.push(`${baseUrl}/${cid}/05_call_1/${v}_05_番.mp3`);
    }
    
    // ===== 敬称 =====
    if (settings.honorific) {
       playlist.push(
       `${baseUrl}/${cid}/06_honorifics/${v}_${settings.honorific}.mp3`);
    }

    // ===== ブロック =====
    if (settings.block) {
      playlist.push(`${baseUrl}/${cid}/07_blocks/${v}_${settings.block}.mp3`);
    }

    // ===== 部屋番号（rooms選択 → call音声を使用）=====
    if (settings.room_1000) {
      playlist.push(
        `${baseUrl}/${cid}/02_call_1000/${v}_${settings.room_1000}.mp3`
      );
    }

    if (settings.room_100 && settings.room_100 !== "0") {
      playlist.push(
        `${baseUrl}/${cid}/03_call_100/${v}_${settings.room_100}.mp3`
      );
    }

    if (settings.room_10 && settings.room_10 !== "0") {
      playlist.push(
    `    ${baseUrl}/${cid}/04_call_10/${v}_${settings.room_10}.mp3`
      );
    }
    
    // ===== 部屋番号 1の位（call_1 統一・完全版）=====
    if (settings.room_1) {

      // value が "0" 以外なら数字（1～9）
      if (settings.room_1 !== "0") {
        playlist.push(
          `${baseUrl}/${cid}/05_call_1/${v}_${settings.room_1}.mp3`
        );

      // 0 の場合 → 「番」
      } else {
        playlist.push(
          `${baseUrl}/${cid}/05_call_1/${v}_05_番.mp3`
        );
      }
    }

    // ===== 呼出場所 =====
    if (settings.place) {
      playlist.push(`${baseUrl}/${cid}/08_places/${v}_${settings.place}.mp3`);
    }

    // ===== 再生 =====
    await playPlaylistGapless(playlist);

    // ===== 再生終了後に入力クリア =====
    clearDisplay();
        
  } catch (err) {
    console.error("呼出中にエラー:", err);
  } finally {
    // 必ずロック解除（途中で失敗しても）
    lockUI(false);
    isPlaying = false;
  }
}

function renderHistory() {
  historyList.innerHTML = "<h4>履歴(Max10件)</h4>" + history.map(h => `<div class="history">${h.time} - ${h.num}</div>`).join("");
}

function updateInformationCurrent(num) {
  const el = document.getElementById("infoCurrent");
  if (!el) return;
  el.innerText = num ;
}

function renderInformationHistory() {
  const box = document.getElementById("infoHistory");
  if (!box) return;

  box.innerHTML = "";

  // 最新順で最大10件
  history.slice(0, 10).forEach(h => {
    const div = document.createElement("div");
    div.className = "info-box";
    div.innerText = h.num ;
    box.appendChild(div);
  });
}

</script>
</body>
</html>
