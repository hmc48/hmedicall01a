<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>呼出システム</title>

<style>
body { font-family: system-ui; margin:0; background:#f2f2f7; }
header { background:#007bff; color:#fff; padding:10px; text-align:center; position:relative; min-height:80px; }
header h2 { margin:0; }
nav button { margin:4px; padding:6px 12px; }
.view { display:none; padding:10px; }
.view.active { display:block; }
.keypad { display:grid; grid-template-columns:repeat(3,1fr); gap:8px; max-width:300px; margin:auto; }
.keypad button { padding:18px; font-size:20px; }
#display { text-align:center; font-size:28px; margin:10px; }
#currentSettings { text-align:center; font-size:14px; margin-bottom:10px; }
.history { background:#fff; padding:8px; margin-top:6px; border-radius:6px; }
#callButton { padding:20px 50px; font-size:24px; font-weight:bold; border-radius:12px; background:#28a745; color:white; border:none; }
</style>
</head>

<body>

<header>
<h2>呼出システム</h2>
<nav>
<button onclick="showView('home')">ホーム</button>
<button onclick="showView('settings')">設定</button>
</nav>
</header>

<div id="home" class="view active">
<div id="display">----</div>
<div id="currentSettings"></div>

<div class="keypad">
<button onclick="addNum(1)">1</button><button onclick="addNum(2)">2</button><button onclick="addNum(3)">3</button>
<button onclick="addNum(4)">4</button><button onclick="addNum(5)">5</button><button onclick="addNum(6)">6</button>
<button onclick="addNum(7)">7</button><button onclick="addNum(8)">8</button><button onclick="addNum(9)">9</button>
<button onclick="clearDisplay()">C</button><button onclick="addNum(0)">0</button><button onclick="backspace()">BS</button>
</div>

<button id="callButton" onclick="call()">呼出</button>
<div id="historyList"></div>
</div>

<div id="settings" class="view">
<p>キャラ <select id="characterSelect"><option value="11_shikoku">11_四国めたん</option><option value="12_zundamon">12_ずんだもん</option><option value="13_kasukabe">13_春日部つむぎ</option></select></p>
<p>チャイム <select id="chime"><option value="">なし</option><option value="m_chime01">チャイム1</option><option value="m_chime02">チャイム2</option><option value="m_chime03">チャイム3</option><option value="m_chime04">チャイム4</option><option value="m_chime05">チャイム5</option><option value="m_chime06">チャイム6</option><option value="m_chime07">チャイム7</option><option value="m_chime08">チャイム8</option><option value="m_chime09">チャイム9</option><option value="m_chime10">チャイム10</option></select></p>
<p>接頭語 <select id="prefix"><option>なし</option><option>大変お待たせいたしました</option><option>お待たせいたしました</option><option>お呼び出しいたします</option></select></p>
<p>敬称 <select id="honorific"><option>なし</option><option>でお待ちの方</option><option>の方</option></select></p>
<p>ブロック <select id="block"><option>なし</option><option>Aブロック</option><option>Bブロック</option><option>Cブロック</option><option>Dブロック</option></select></p>
<p>再生速度 <select id="playbackRate"><option value="0.8">0.8倍</option><option value="0.9">0.9倍</option><option value="1.0">1.0倍</option><option value="1.1">1.1倍</option><option value="1.2">1.2倍</option><option value="1.3">1.3倍</option><option value="1.4">1.4倍</option><option value="1.5">1.5倍</option><option value="1.8">1.8倍</option><option value="2.0">2.0倍</option><option value="2.5">2.5倍</option></select></p>
<button onclick="saveSettings()">設定を保存</button>
</div>

<script>
const CONFIG = {"baseAudioUrl": "https://hmc48.github.io/hmedicall01a/setting", "characters": [{"id": "11_shikoku", "name": "11_四国めたん", "image": "https://hmc48.github.io/hmedicall01a/images/11_四国めたん.webp", "image_credit": "https://hmc48.github.io/hmedicall01a/images_credit/11_四国めたん.png", "voice": "11_shikoku"}, {"id": "12_zundamon", "name": "12_ずんだもん", "image": "https://hmc48.github.io/hmedicall01a/images/12_ずんだもん.webp", "image_credit": "https://hmc48.github.io/hmedicall01a/images_credit/12_ずんだもん.png", "voice": "12_zundamon"}, {"id": "13_kasukabe", "name": "13_春日部つむぎ", "image": "https://hmc48.github.io/hmedicall01a/images/13_春日部つむぎ.webp", "image_credit": "https://hmc48.github.io/hmedicall01a/images_credit/13_春日部つむぎ.png", "voice": "13_kasukabe"}], "chimes": [{"label": "なし", "value": ""}, {"label": "チャイム1", "value": "m_chime01"}, {"label": "チャイム2", "value": "m_chime02"}, {"label": "チャイム3", "value": "m_chime03"}, {"label": "チャイム4", "value": "m_chime04"}, {"label": "チャイム5", "value": "m_chime05"}, {"label": "チャイム6", "value": "m_chime06"}, {"label": "チャイム7", "value": "m_chime07"}, {"label": "チャイム8", "value": "m_chime08"}, {"label": "チャイム9", "value": "m_chime09"}, {"label": "チャイム10", "value": "m_chime10"}], "prefixes": ["なし", "大変お待たせいたしました", "お待たせいたしました", "お呼び出しいたします"], "honorifics": ["なし", "でお待ちの方", "の方"], "blocks": ["なし", "Aブロック", "Bブロック", "Cブロック", "Dブロック"], "rooms": ["なし", "0", "1", "2", "3", "4", "5", "6", "7", "8", "9"], "places": ["なし", "窓口までお越しください", "受付までお越しください", "診察室までお越しください"], "playbackRates": [0.8, 0.9, 1.0, 1.1, 1.2, 1.3, 1.4, 1.5, 1.8, 2.0, 2.5]};
let currentNum = "";
let isPlaying = false;
let history = JSON.parse(localStorage.getItem("history") || "[]");
let settings = JSON.parse(localStorage.getItem("settings") || "{}");

function showView(id){
 document.querySelectorAll(".view").forEach(v=>v.classList.remove("active"));
 document.getElementById(id).classList.add("active");
}

function addNum(n){ currentNum += n; updateDisplay(); }
function clearDisplay(){ currentNum=""; updateDisplay(); }
function backspace(){ currentNum=currentNum.slice(0,-1); updateDisplay(); }
function updateDisplay(){ document.getElementById("display").innerText=currentNum||"----"; }

function playAudio(url){
 return new Promise(res=>{
  const a=new Audio(url);
  a.playbackRate=settings.playbackRate||1.0;
  a.onended=res;
  a.onerror=res;
  a.play().catch(res);
 });
}

async function call(){
 if(isPlaying) return;
 isPlaying=true;

 try{
  const char=CONFIG.characters.find(c=>c.id===settings.character)||CONFIG.characters[0];
  const base=CONFIG.baseAudioUrl;
  const v=char.voice;
  const cid=char.id;
  const num=(currentNum||"0").padStart(4,"0");
  const list=[];

  if(settings.chime) list.push(`${base}/m_chime/${settings.chime}.mp3`);

  if(num[0]!=="0") list.push(`${base}/${cid}/02_call_1000/${v}_02_${num[0]}000.mp3`);
  if(num[1]!=="0") list.push(`${base}/${cid}/03_call_100/${v}_03_${num[1]}00.mp3`);
  if(num[2]!=="0") list.push(`${base}/${cid}/04_call_10/${v}_04_${num[2]}0.mp3`);
  if(num[3]!=="0") list.push(`${base}/${cid}/05_call_1/${v}_05_${num[3]}.mp3`);

  for(const u of list){ await playAudio(u); }

 }finally{
  isPlaying=false;
  clearDisplay();
 }
}

function saveSettings(){
 settings={
  character:document.getElementById("characterSelect").value,
  chime:document.getElementById("chime").value,
  prefix:document.getElementById("prefix").value,
  honorific:document.getElementById("honorific").value,
  block:document.getElementById("block").value,
  playbackRate:parseFloat(document.getElementById("playbackRate").value)
 };
 localStorage.setItem("settings",JSON.stringify(settings));
}
</script>

</body>
</html>
